function createUploadBox(){fileInput.addEventListener("change",()=>{Array.from(fileInput.files).forEach(e=>{if(e.size>MAX_FILE_SIZE){document.getElementById("span-modal-error").innerText=`The file "${e.name}" exceeds the maximum allowed size of ${formatSize(MAX_FILE_SIZE)}.`,errorModal.show();return}const n=getUuid(),s=document.createElement("div");s.className="pu-file-item",s.dataset.uuid=n;const a=document.createElement("span");a.textContent=e.name,a.className="file-name";const i=document.createElement("span");i.className="upload-status",i.textContent="Ready";const o=document.createElement("progress");o.className="upload-progress",e.size==0?o.max=1:o.max=e.size,o.value=0;const r=document.createElement("span");r.className="file-size",r.textContent=formatSize(e.size);const t=document.createElement("button");t.type="button",t.title="Remove",t.className="btn btn-sm btn-link text-light p-0",t.innerHTML='<i class="bi bi-x-circle"></i>',t.onclick=async()=>{filesMap.get(n).removed=!0,filesMap.get(n).status="removed";const e=filesMap.get(n);if(e.controller&&e.controller.abort(),s.remove(),updateUploadButtonState(),e.serverUuid)try{await unreserve(e.serverUuid)}catch(e){console.error("Unreserve failed",e)}},s.append(a,i,o,r,t),fileList.appendChild(s),filesMap.set(n,{uuid:n,file:e,removed:!1,status:"pending",controller:new AbortController,lastSpeed:"",elements:{progressBar:o,progressText:i,removeBtn:t,item:s}}),updateUploadButtonState()}),fileInput.value=""}),["dragenter","dragover","dragleave","drop"].forEach(e=>{uploadBox.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation()},!1)}),["dragenter","dragover"].forEach(e=>{uploadBox.addEventListener(e,()=>uploadBox.classList.add("highlight"),!1)}),["dragleave","drop"].forEach(e=>{uploadBox.addEventListener(e,()=>uploadBox.classList.remove("highlight"),!1)}),uploadBox.addEventListener("drop",e=>{const t=e.dataTransfer,n=t.files;handleFiles(n)}),window.addEventListener("paste",e=>{const t=e.clipboardData.items,n=[];for(let e=0;e<t.length;e++)t[e].kind==="file"?n.push(t[e].getAsFile()):t[e].kind==="string"&&t[e].type==="text/plain"&&t[e].getAsString(e=>{const t=new Blob([e],{type:"text/plain"}),n=new File([t],"pasted-text.txt",{type:"text/plain"});handleFiles([n])});n.length>0&&handleFiles(n)})}function setUnload(){window.addEventListener("beforeunload",e=>{const t=Array.from(filesMap.values()).some(e=>!e.removed);t&&(e.preventDefault(),e.returnValue="")}),window.addEventListener("unload",()=>{for(const e of filesMap.values())!e.removed&&e.serverUuid&&unreserve(e.serverUuid)})}function handleFiles(e){const t=new DataTransfer;Array.from(e).forEach(e=>t.items.add(e)),fileInput.files=t.files,fileInput.dispatchEvent(new Event("change"))}function updateUploadButtonState(){const e=document.getElementById("uploadbutton"),t=Array.from(filesMap.values()).filter(e=>!e.removed&&e.status==="pending");e.disabled=isUploadInProgress||t.length===0}function showModal(e){let t="";switch(e){case"alluploaded":new bootstrap.Modal(document.getElementById("allUploadedModal"),{keyboard:!1,backdrop:"static"}).show();return;case"maxfiles":maxFilesRemaining==1?t="Too many files are selected for upload. Please only select 1 file.":t="Too many files are selected for upload. Please only select "+maxFilesRemaining+" files or fewer.";break;case"maxfilesdynamic":t="Some files could not be uploaded because the server rejected the request. This likely occurred because another user was uploading files at the same time and the maximum file limit was reached.";break;case"expired":t="The upload request exceeded the permitted time limit, and uploading additional files is no longer possible.";break}document.getElementById("span-modal-error").innerText=t,errorModal.show()}function formatSize(e){const n=["B","KB","MB","GB"];let t=0;for(;e>=1024&&t<n.length-1;)e/=1024,t++;return e.toFixed(1)+" "+n[t]}async function withRetry(e,{retries:t=3,retryDelay:n=3e3,onRetry:s,onWait:o,signal:i}={}){let r,a=1;const c=Date.now(),l=6e4;for(;a<=t;){if(i&&i.aborted)throw new Error("Cancelled");try{return await e()}catch(e){if(r=e,e.message==="Cancelled"||i&&i.aborted)throw e;if(e.status===429){const e=Date.now()-c;if(e<l){o&&o(),await new Promise(e=>setTimeout(e,5e3));continue}}if(s&&a<t&&s(a,e),e.status===400||e.status===401)throw e;if(a<t)a++,await new Promise(e=>setTimeout(e,n));else break}}throw r}function getQueuedFileCount(){let e=0;for(const t of filesMap.values())t.removed||e++;return e}async function initUpload(){const e=document.getElementById("uploadbutton");isUploadInProgress=!0,e.disabled=!0;try{await startUpload()}catch(e){console.error(e)}finally{isUploadInProgress=!1,updateUploadButtonState()}}async function startUpload(){if(!IS_UNLIMITED_FILES&&getQueuedFileCount()>maxFilesRemaining){showModal("maxfiles");return}for(const t of filesMap.values()){if(t.removed||t.status!=="pending")continue;const{file:n,uuid:o,elements:e}=t;t.status="uploading",e.progressBar.style.display="",e.progressText.style.color="";let s="";try{e.progressText.textContent="Reserving...";const a=await reserveChunk(e);t.serverUuid=a,e.removeBtn.innerHTML='<i class="bi bi-stop-circle text-danger"></i>',e.removeBtn.title="Cancel Upload";let i=0;do{if(t.controller.signal.aborted)return;const o=n.slice(i,i+CHUNK_SIZE);await withRetry(async()=>new Promise((r,c)=>{const d=new FormData;d.append("file",o),d.append("uuid",a),d.append("filesize",n.size),d.append("offset",i);const l=new XMLHttpRequest;t.xhr=l,l.open("POST",UPLOAD_URL),l.setRequestHeader("apikey",API_KEY),l.setRequestHeader("fileRequestId",FILE_REQUEST_ID);const h=Date.now(),u=()=>{l.abort(),c(new Error("Cancelled"))};t.controller.signal.addEventListener("abort",u),l.upload.onprogress=t=>{if(t.lengthComputable){const o=i+t.loaded,r=n.size===0?1:n.size,c=Math.floor(o/r*100),a=(Date.now()-h)/1e3;a>0&&(s=` (${formatSize(t.loaded/a)}/s)`),e.progressBar.value=o,e.progressText.textContent=c+"%"+s}},l.onload=async()=>{t.controller.signal.removeEventListener("abort",u),l.status>=200&&l.status<300?r():c(await parseXhrError(l))},l.onerror=()=>{const e=new Error(`Server Error`);e.status=l.status,c(e)},l.send(d)}),{signal:t.controller.signal,onWait:()=>{e.progressText.textContent="Waiting for upload slot..."},onRetry:(t,n)=>{e.progressText.textContent=`Retry ${t}/3: ${n.message}${s}`}}),i+=o.size}while(i<n.size)await finaliseUpload(n,a,e),t.status="completed",e.progressText.textContent="Completed",e.item.style.opacity="0.6",e.removeBtn.remove(),filesMap.get(o).removed=!0,maxFilesRemaining--,maxFilesRemaining===0&&showModal("alluploaded")}catch(n){if(n.message==="Cancelled"||t.controller.signal.aborted){t.status="pending";return}t.status="error",e.progressText.textContent=n.message||"Upload failed",e.progressText.style.color="#ff6b6b",e.progressBar.style.display="none",e.removeBtn.innerHTML='<i class="bi bi-trash"></i>',e.removeBtn.title="Remove from list"}}}async function parseXhrError(e){const t={ok:!1,status:e.status,text:async()=>e.responseText||`HTTP ${e.status}`};return await parseErrorResponse(t)}async function parseErrorResponse(e){const n=await e.text();let t=null;try{t=JSON.parse(n)}catch{}if(t&&t.Result==="error"){let n;switch(t.ErrorCode){case 9:n="File size limit exceeded";break;case 14:n="Upload request has expired",showModal("expired");break;case 15:n="Maximum file count reached",showModal("maxfilesdynamic");break;case 16:n="Too many requests, please try again later";break;default:n=t.ErrorMessage||"Unknown upload error"}const s=new Error(n);return s.status=e.status,s.code=t.ErrorCode,s.raw=t,s}const s=new Error(n||`HTTP ${e.status}`);return s.status=e.status,s}async function reserveChunk(e){return withRetry(async()=>{const e=await fetch(RESERVE_URL,{method:"POST",headers:{id:FILE_REQUEST_ID,apikey:API_KEY}});if(!e.ok)throw await parseErrorResponse(e);const t=await e.json();if(!t.Uuid)throw new Error("Invalid reserve response");return t.Uuid},{onRetry:(t,n)=>{e.progressText.textContent=`Retry ${t}/3: ${n.message}`}})}async function finaliseUpload(e,t,n){await withRetry(async()=>{const n=await fetch(COMPLETE_URL,{method:"POST",headers:{uuid:t,fileRequestId:FILE_REQUEST_ID,filename:encodeFilename(e.name),filesize:e.size,nonblocking:!0,contenttype:e.type||"application/octet-stream",apikey:API_KEY}});if(!n.ok)throw await parseErrorResponse(n)},{onRetry:(e,t)=>{n.progressText.textContent=`Retry ${e}/3: ${t.message}`}})}function encodeFilename(e){return"base64:"+Base64.encode(e)}async function unreserve(e){if(!e)return;try{await fetch(UNRESERVE_URL,{method:"POST",headers:{uuid:e,apikey:API_KEY,id:FILE_REQUEST_ID},keepalive:!0})}catch(e){console.error("Unreserve failed",e)}}