{{ define "logs" }}{{ template "header" . }}

<style>
    .stat-card {
        background: #1a1d20;
        border: 1px solid #2d3238;
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.3) !important;
        border-color: #0d6efd;
    }
    .stat-icon {
        opacity: 0.6;
        font-size: 1.2rem;
    }
    .progress-stat {
        height: 4px;
        background-color: #2b3035;
    }
    
    .log-dark-input {
        background-color: #2b3035 !important;
        border-color: #444b52 !important;
        color: #e9ecef !important;
    }
    .log-dark-input:focus {
        background-color: #32383e !important;
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
    .input-group-text-dark {
        background-color: #1a1d20 !important;
        border-color: #444b52 !important;
        color: #adb5bd !important;
    }
    #logviewer::-webkit-scrollbar { width: 8px; }
    #logviewer::-webkit-scrollbar-track { background: #000; }
    #logviewer::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
</style>

<div class="container-fluid py-4" style="max-width: 1200px;">
    
    <div class="row g-3 mb-4">
        <div class="col-6 col-lg-2">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Uptime</div>
                    <div class="h5 mb-0 text-light"><span id="uptime"></span></div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-2">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="text-muted small text-uppercase fw-bold mb-1">CPU Load</div>
                    <div class="h5 mb-2 text-light" id="labelCpu">{{ .CpuLoad}}%</div>
                    <div class="progress progress-stat">
                        <div class="progress-bar" id="barCpu" style="width: {{ .CpuLoad}}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-2">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Memory</div>
                    <div class="h5 mb-2 text-light text-nowrap"><span id="usedMemory"></span> / <span id="totalMemory"></span> <span id="memoryUnit" class="small opacity-50"></span></div>
                    <div class="progress progress-stat">
                        <div class="progress-bar" id="barMemory" style="width: {{.MemoryUsagePercent}}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-2">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Disk Space</div>
                    <div class="h5 mb-2 text-light text-nowrap"><span id="usedDisk"></span> / <span id="totalDisk"></span> <span id="diskUnit" class="small opacity-50"></span></div>
                    <div class="progress progress-stat">
                        <div class="progress-bar" id="barDisk" style="width: {{.DiskUsagePercent}}%"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-2">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Data Served</div>
                    <div class="h5 mb-0 text-light"><span id="totalTraffic"></span> <span id="totalTrafficUnit" class="small opacity-50"></span></div>
                </div>
            </div>
        </div>

        <div class="col-6 col-lg-2">
            <div class="card stat-card border-0 shadow-sm h-100">
                <div class="card-body p-3">
                    <div class="text-muted small text-uppercase fw-bold mb-1">Uploaded Files</div>
                    <div class="h5 mb-0 text-light"><span id="labelActiveFiles"> {{ .TotalFiles }}</span> <span class="small opacity-50">Total</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="card border-0 shadow-lg bg-dark overflow-hidden">
        <div class="card-header bg-dark border-bottom border-secondary py-3 d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <h6 class="mb-0 fw-bold text-light me-3">System Logs</h6>
            </div>
        </div>
        
        <div class="card-body p-0 bg-black">
            <textarea 
                class="form-control bg-black text-info font-monospace border-0 p-4" 
                id="logviewer" 
                rows="20" 
                readonly 
                style="resize: none; font-size: 0.85rem; line-height: 1.5; outline: none; border-radius: 0;">
                	Loading...
            </textarea>
        </div>

        <div class="card-footer bg-dark border-top border-secondary p-3">
            <div class="row g-2 align-items-center">
                <div class="col-md-5">
                    <div class="input-group input-group-sm">
                        <span class="input-group-text input-group-text-dark">Filter</span>
                        <select id="logFilter" class="form-select log-dark-input" onchange="filterLogs(this.value)">
                            <option value="all">All Events</option>
                            <option value="warning">Warnings</option>
                            <option value="auth">Security</option>
                            <option value="upload">Uploads</option>
                            <option value="edit">Modifications</option>
                            <option value="download">Downloads</option>
                            <option value="info">Info</option>
                        </select>
                    </div>
                </div>
                
                <div class="col-md-2"></div>

                <div class="col-md-5">
                    <div class="d-flex gap-2 justify-content-md-end">
{{ if or (eq .ActiveUser.UserLevel 0) (eq .ActiveUser.UserLevel 1) }}
                        <select id="deleteLogsSel" class="form-select form-select-sm log-dark-input w-auto">
                            <option value="none">Delete Logs...</option>
                            <option value="30">Older than 30 days</option>
                            <option value="14">Older than 14 days</option>
                            <option value="7">Older than 7 days</option>
                            <option value="2">Older than 2 days</option>
                            <option value="all">Delete all logs</option>
                        </select>
                        <button class="btn btn-sm btn-outline-light px-3" onclick="deleteLogs()">Execute</button>
{{ else }}
                    <select id="deleteLogsSel" disabled class="form-select form-select-sm log-dark-input w-auto disabled">
                        <option value="none">Only administrators can delete logs</option>
                    </select>
                        <button class="btn btn-sm btn-outline-light px-3" disabled onclick="">Execute</button>
{{ end }}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="./js/min/admin.min.{{ template "js_admin_version"}}.js"></script>
<script>
    const textarea = document.getElementById('logviewer');
    var logContent = '';
    
    
    function setMemoryUsage(used, total) {
    	insertReadableSizeTwoOutputs(total, 'totalMemory', 'memoryUnit');
    	let unit = document.getElementById('memoryUnit').innerText;
    	insertReadableSizeForcedUnit(used, 'usedMemory', unit);
    }
    function setDiskUsage(used, total) {
    	insertReadableSizeTwoOutputs(total, 'totalDisk', 'diskUnit');
    	let unit = document.getElementById('diskUnit').innerText;
    	insertReadableSizeForcedUnit(used, 'usedDisk', unit);
    }
    
function formatDuration(seconds) {
  const units = [
    { label: "y", value: 31536000 },
    { label: "d", value: 86400 },
    { label: "h", value: 3600 },
    { label: "m", value: 60 },
    { label: "s", value: 1 },
  ];

  let startIndex = units.findIndex(unit => seconds >= unit.value);

  // If everything is below 1 minute, force start at minutes
  if (startIndex === -1 || units[startIndex].label === "s") {
    startIndex = units.findIndex(u => u.label === "m");
  }

  const first = units[startIndex];
  const second = units[startIndex + 1];

  const firstAmount = Math.floor(seconds / first.value);
  const remainder = seconds % first.value;
  const secondAmount = Math.floor(remainder / second.value);

  return `${firstAmount}${first.label} ${secondAmount}${second.label}`;
}

function addUptime() {
    if (currentUptime > 3600) {
        return;
    }
    setTimeout(() => {
        currentUptime = currentUptime + 1;
        document.getElementById('uptime').innerText = formatDuration(currentUptime);
        addUptime();
    }, 1000);
}

function setPercentageBar(id, num1, num2) {
    let percentage = num1;
    if (num2 !== undefined) {
        percentage = ((num1 / num2) * 100);
    }

    const bar = document.getElementById(id);

    bar.classList.remove("bg-success");
    bar.classList.remove("bg-warning");
    bar.classList.remove("bg-danger");

    if (percentage < 70) {
        bar.classList.add("bg-success");
    }
    if (percentage >= 70 && percentage < 90) {
        bar.classList.add("bg-warning");
    }
    if (percentage >= 90) {
        bar.classList.add("bg-danger");
    }
    bar.style.width = percentage + '%';
}

var lastLogUpdate = 0;

async function loadLogs(timestamp) {
    const textarea = document.getElementById('logviewer');

    try {
        const data = await apiLogGet(timestamp);
        lastLogUpdate = data.timestamp;
        let doScroll = true;
        if (timestamp != 0) {
            if (data.logEntries == "") {
                return;
            }
            doScroll = allowScroll();
            logContent = logContent + data.logEntries;
        } else {
            logContent = data.logEntries;
        }
        filterLogs(document.getElementById('logFilter').value);
        if (doScroll) {
            textarea.scrollTop = textarea.scrollHeight;
        }
    } catch (error) {
        lastLogUpdate = 0;
        console.error("Failed to load logs:", error);
        textarea.value = "Error loading logs. See console for details.";
    }
}


async function loadStatus() {
    try {
        const data = await apiLogSystemStatus();
        
    currentUptime = data.uptime;
    document.getElementById('labelCpu').innerText = data.cpuLoad+'%';
    document.getElementById('labelActiveFiles').innerText = data.activeFiles;
    setPercentageBar("barCpu", data.cpuLoad);
    setPercentageBar("barDisk", data.diskUsagePercentage);
    setPercentageBar("barMemory", data.memoryUsagePercentage);
    setMemoryUsage(data.memoryUsed, data.memoryTotal);
    setDiskUsage(data.diskUsed, data.diskTotal);
    insertReadableSizeTwoOutputs(data.dataServed, 'totalTraffic', 'totalTrafficUnit');
    } catch (error) {
        console.error("Failed to server status:", error);
    }
}

async function pollInfo() {
firstStart=true;
    while (true) {
        await loadLogs(lastLogUpdate);
        if (firstStart) {
        	firstStart= false;
        } else {
        	await loadStatus();
        }
        await new Promise(r => setTimeout(r, POLL_INTERVAL_S * 1000));
    }
}

function allowScroll() {
	const textarea = document.getElementById('logviewer');
	return textarea.scrollTop + textarea.clientHeight >= textarea.scrollHeight - 5;
}


    
    const POLL_INTERVAL_S = 10;
    var currentUptime = {{.Uptime}};
    setPercentageBar("barCpu", {{ .CpuLoad}});
    setPercentageBar("barDisk", {{ .DiskUsage}}, {{.DiskTotal}});
    setPercentageBar("barMemory", {{.MemoryUsage}}, {{.MemoryTotal}});
    setMemoryUsage({{.MemoryUsage}}, {{.MemoryTotal}});
    setDiskUsage({{.DiskUsage}}, {{.DiskTotal}});
    document.getElementById('uptime').innerText = formatDuration(currentUptime);
    insertReadableSizeTwoOutputs({{.TotalTraffic}}, 'totalTraffic', 'totalTrafficUnit');
    addUptime();
    pollInfo();
    

    
    
    
</script>

{{ template "pagename" "LogOverview"}}
{{ template "customjs" .}}
{{ template "footer" true}}
{{ end }}
