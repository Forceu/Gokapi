{{define "publicUpload"}}{{template "header" .}}



<style>
  .upload-box {
    border: 2px dashed #6c757d;
    border-radius: 8px;
    padding: 2rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .upload-box:hover {
    background-color: rgba(255,255,255,0.05);
  }

  .file-list {
    margin-top: 1.5rem;
  }

  .file-item {
    display: flex;
    justify-content: space-between;
    padding: 0.5rem 0;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    font-size: 0.95rem;
  }

  .file-size {
    opacity: 0.75;
  }

  .info-box {
    background-color: rgba(255,255,255,0.05);
    border-radius: 6px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    text-align: left;
  }

  .info-box h6 {
    margin-bottom: 0.5rem;
  }

  .info-box ul {
    margin-bottom: 0;
    padding-left: 1.2rem;
  }
</style>

<main style="margin-top: 2rem">
  <div class="row justify-content-center">
    <div class="col-lg-8">

      <div class="card bg-dark text-white">
        <div class="card-body">

          <h3 class="card-title text-center mb-4">Upload Files</h3>

{{ if ne .FileRequest.Notes "" }}
          <div class="info-box">
            <h6>Note</h6>
            <p class="mb-0">
              {{.FileRequest.Notes }}
            </p>
          </div>
 {{ end }}

{{ if .FileRequest.HasRestrictions }}
          <div class="info-box">
            <h6>Upload restrictions</h6>
            <ul>
    {{ if not (.FileRequest.IsUnlimitedTime) }}
              <li>Upload possible until: <strong><span id="expirydate">{{ .FileRequest.Expiry }}</span></strong></li>
              <script>insertFormattedDate({{ .FileRequest.Expiry }}, "expirydate");</script>
    {{ end }}
    {{ if or  (not (.FileRequest.IsUnlimitedSize)) (lt .FileRequest.CombinedMaxSize 5000) }}
              <li>Maximum file size: <strong><span id="maxfilesize"></span></strong></li>
              <script>insertReadableSize({{ .FileRequest.CombinedMaxSize }}, 1024 * 1024, "maxfilesize");</script>
              
    {{ end }}
    {{ if not (.FileRequest.IsUnlimitedFiles) }}
              <li>Maximum number of files: <strong>{{ .FileRequest.FilesRemaining }}</strong></li>
    {{ end }}
            </ul>
          </div>
{{ end }}


          <label for="fileInput" class="upload-box text-center w-100">
            <p class="mb-2 fs-5">Drag & drop files here</p>
            <p class="mb-0 opacity-75">or paste or click to select</p>
            <input
              type="file"
              id="fileInput"
              class="d-none"
              multiple
            >
          </label>

          <div id="fileList" class="file-list"></div>

          <div class="text-center mt-4">
            <button class="btn btn-secondary" disabled>
              Upload (TODO)
            </button>
          </div>

        </div>
      </div>

    </div>
  </div>
</main>

<script>
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');

  fileInput.addEventListener('change', () => {
    fileList.innerHTML = '';

    Array.from(fileInput.files).forEach(file => {
      const item = document.createElement('div');
      item.className = 'file-item';

      const name = document.createElement('span');
      name.textContent = file.name;

      const size = document.createElement('span');
      size.className = 'file-size';
      size.textContent = formatSize(file.size);

      item.appendChild(name);
      item.appendChild(size);
      fileList.appendChild(item);
    });
  });

  function formatSize(bytes) {
    const units = ['B', 'KB', 'MB', 'GB'];
    let i = 0;
    while (bytes >= 1024 && i < units.length - 1) {
      bytes /= 1024;
      i++;
    }
    return bytes.toFixed(1) + ' ' + units[i];
  }
</script>


<script>
const CHUNK_SIZE = {{ .ChunkSize }} * 1024 * 1024;
const UPLOAD_URL = "./api/chunk/uploadRequestAdd";
const COMPLETE_URL = "./api/chunk/uploadRequestComplete";

const FILE_REQUEST_ID = "{{ .FileRequest.Id }}";
const API_KEY = "{{ .FileRequest.ApiKey }}";


async function startUpload() {
  const files = document.getElementById("fileInput").files;
  const status = document.getElementById("status");
  status.innerHTML = "";

  for (const file of files) {
    const fileDiv = document.createElement("div");
    fileDiv.className = "file";
    fileDiv.innerHTML = `
      <strong>${file.name}</strong><br>
      <progress value="0" max="${file.size}"></progress>
      <span class="progressText">0%</span>
    `;
    status.appendChild(fileDiv);

    const progressBar = fileDiv.querySelector("progress");
    const progressText = fileDiv.querySelector(".progressText");

    const uuid = getUuid();
    let offset = 0;

    while (offset < file.size) {
      const chunk = file.slice(offset, offset + CHUNK_SIZE);

      const formData = new FormData();
      formData.append("file", chunk);
      formData.append("uuid", uuid);
      formData.append("filesize", file.size);
      formData.append("offset", offset);

      const response = await fetch(UPLOAD_URL, {
        method: "POST",
        body: formData,
        headers: {
        'apikey': API_KEY,
        "fileRequestId": FILE_REQUEST_ID
        }
      });

      if (!response.ok) {
        throw new Error(`Chunk upload failed: ${response.status}`);
      }

      offset += chunk.size;
      progressBar.value = offset;
      progressText.textContent = Math.floor((offset / file.size) * 100) + "%";
    }

    // Finalize upload
    await finalizeUpload(file, uuid);
    progressText.textContent = "âœ” Completed";
  }
}

async function finalizeUpload(file, uuid) {
  const headers = {
    "uuid": uuid,
    "fileRequestId": FILE_REQUEST_ID,
    "filename": encodeFilename(file.name),
    "filesize": file.size,
        'apikey': API_KEY,
    "contenttype": file.type || "application/octet-stream"
  };

  const response = await fetch(COMPLETE_URL, {
    method: "POST",
    headers: headers
  });

  if (!response.ok) {
    throw new Error(`Finalize failed: ${response.status}`);
  }

  return response;
}

function encodeFilename(name) {
  return "base64:" + btoa(unescape(encodeURIComponent(name)));
}
</script>
        <script src="./js/min/uuid.min.js"></script>

{{ template "pagename" "PublicUpload"}}
{{ template "customjs" .}}
        
{{template "footer"}}    
{{end}}
